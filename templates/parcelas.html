{% extends "base.html" %}
{% block content %}
<h1>Parcelas - Contrato {{ contrato.contrato or contrato.numero or contrato.id }}</h1>

<div class="row row-cols-2 row-cols-md-4 g-3 mb-4">
  {% macro card(label, val) -%}
  <div class="col">
    <div class="card h-100 shadow-sm">
      <div class="card-body py-2">
        <div class="text-muted small">{{ label }}</div>
        <div class="fs-5 fw-semibold">R$ {{ val|brl }}</div>
      </div>
    </div>
  </div>
  {%- endmacro %}

  {{ card('Valor', resumo.valor) }}
  {{ card('Valor pago', resumo.valor_pago) }}
  {{ card('Valor abatido', resumo.valor_abatido) }}
  {{ card('Custas', resumo.custas) }}
  {{ card('Custas deduzida', resumo.custas_deduzida) }}
  {{ card('Protesto', resumo.protesto) }}
  {{ card('Protesto deduzido', resumo.protesto_deduzido) }}
  {{ card('Honor치rio', resumo.honorario) }}
  {{ card('Honor치rio repassado', resumo.honorario_repassado) }}
  {{ card('Alvar치', resumo.alvara) }}
  {{ card('Alvar치 recebido', resumo.alvara_recebido) }}
  {{ card('Ganho', resumo.ganho) }}
</div>

<table class="table table-sm">
  <thead>
    <tr>
      <th>#</th>
      <th>Vencimento</th>
      <th>Valor</th>
      <th>Baixa</th>
    </tr>
  </thead>
  <tbody>
    {% set lista = parcelas if parcelas is defined else parcels %}
    {% for p in lista %}
      {# valor da parcela com fallbacks #}
      {% set valor_parc = (p.valor if p.valor is not none else (p.valor_parcela if p.valor_parcela is not none else (p.valor_total if p.valor_total is not none else 0))) %}
      {# pega data de baixa se existir #}
      {% set data_baixa = p.data_baixa or p.baixa_data or p.baixado_em or p.pago_em %}
      {# pega flags booleanas de baixa #}
      {% set flag_baixa = p.baixa or p.pago or p.baixada or p.liquidada %}
      <tr>
        <td>{{ p.numero or loop.index }}</td>
        <td>{{ p.vencimento|fmtdate }}</td>
        <td>R$ {{ valor_parc|brl }}</td>
        <td>
          {% if data_baixa %}
            Baixada em {{ data_baixa|fmtdate }}
          {% elif flag_baixa %}
            Baixada
          {% else %}
            <form action="{{ url_for('baixar_parcela', contrato_id=contrato.id, parcela_id=p.id) }}" method="post" style="display:inline">
              <button class="btn btn-primary btn-sm">Dar Baixa</button>
            </form>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<a href="{{ url_for('index') }}" class="btn btn-secondary btn-sm">Voltar</a>
{% endblock %}